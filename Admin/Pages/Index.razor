@page "/"

@using Microsoft.EntityFrameworkCore
@using Olympiad.Shared.Models
@using System.Text.RegularExpressions

@using OpenQA.Selenium.Chrome
@using OpenQA.Selenium
@using NPOI.SS.UserModel;
@using NPOI.XSSF.UserModel;
@using CsvHelper;

@inject ApplicationDbContext db

<h2>Solutions count</h2>

<label>
    Auto update
    <input type="checkbox" @bind="autoUpdate" />
</label>
@if (!autoUpdate)
{
    <button class="btn btn-primary" @onclick="@Update">Update</button>
}

<table>
    <thead>
        <tr>
            <th>Type</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var i in solutionCountRecords)
        {
            <tr>
                <td>@i.Status</td>
                <td>@i.Count</td>
            </tr>
        }
    </tbody>
</table>
<Olympiad.Admin.Components.Logs @ref="Logs" />

@code {

    List<SolutionCountRecord> solutionCountRecords = new List<SolutionCountRecord>();

    bool autoUpdate = false;
    Olympiad.Admin.Components.Logs Logs;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender)
        {
            await Update();
            UpdateCycle();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

    }

    private async Task UpdateCycle()
    {
        while (true)
        {
            await Task.Delay(TimeSpan.FromSeconds(1));
            if (autoUpdate)
                await Update();
        }
    }

    private async Task Update()
    {
        await Logs.Log($"Updating");
        solutionCountRecords = await db.Solutions.GroupBy(s => s.Status).Select(g => new SolutionCountRecord { Status = g.Key.ToString(), Count = g.Count() }).ToListAsync();
        await Logs.Log($"Updated");
        StateHasChanged();
    }

    class SolutionCountRecord
    {
        public string Status { get; set; }
        public int Count { get; set; }
    }
}