@page "/users/generate"
@inherits OwningComponentBase<Microsoft.AspNetCore.Identity.UserManager<User>>

@inject Microsoft.Extensions.Options.IOptions<Olympiad.Shared.Models.Settings.GenerateSettings> generateSettings
@inject Olympiad.Admin.Services.UserPasswordGenerator userPasswordGenerator


<h3>GenerateUsers</h3>
<NavLink href="users">Back to users</NavLink>

<textarea @bind="rows"></textarea>
<button @onclick="Generate">Generate</button>


@if (generatedUsers == null)
{
    <p>No generated users</p>
}
else
{
    <ul>
        @foreach (var generatedUser in generatedUsers)
        {
            <li>@($"{generatedUser.Login} {generatedUser.Password}")</li>
        }
    </ul>
}

@code {
    string rows = "";
    List<PublicAPI.Responses.GenerateUsersRespponce> generatedUsers;
    private async Task Generate()
    {
        var userIds = rows.Split('\n', StringSplitOptions.RemoveEmptyEntries);
        


        List<PublicAPI.Responses.GenerateUsersRespponce> generates = new List<PublicAPI.Responses.GenerateUsersRespponce>();


        foreach (var studentId in userIds)
        {
            User user = new User()
            {
                Email = $"{studentId}{generateSettings.Value.Domain}",
                UserName = studentId,
                EmailConfirmed = true,
                StudentID = studentId
            };
            var password = userPasswordGenerator.GeneratePassword();
            var result = await Service.CreateAsync(user, password);
            result = await Service.AddToRoleAsync(user, "User");
            generates.Add(new PublicAPI.Responses.GenerateUsersRespponce { Login = user.UserName, Password = password });
        }

        generatedUsers = generates;
    }
}
